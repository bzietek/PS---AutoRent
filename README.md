# Auto Rent

## Oracle database
As a reqiurement we are supposed to connect to an Oracle database. This requires a specific php extention (oci8). It is not available in the apt repository (not even at Ondřej Surý's). As such it is necessary to install it using pecl and to make sure all the dependencies are met (like Oracle Instant Client)

## Dev environment
Please note that this section assumes the installation right on the developer's host machine. 

### Install the application dependencies
To use the application the dependencies need to be met. Fortunately php uses a package manager called composer. To install it please proceed to [composer](https://getcomposer.org/download/).

After composer has been installed run the following:
```bash
composer install
```

### Set up the .env file
Copy the provided .env.sample and update it with correct values (Values there are set for using the compose.yaml).
```bash
cp .env.sample .env
```

### Run the application

#### Start the database
```bash
docker compose up -d
```

#### Start serving content
content is served on port 8080 by default
```bash
php yii serve
```

#### Run a command
```bash
php yii command-controller/command-action
```

#### on docker
```bash
docker compose -d
```

## Dev environment (dockerized)
This is the preferred method, as development method, as development is hardly impaired and there is no additional need for installation other than building the dockerfile (docker compose is capable of doing so). \
The provided docker compose file also contains a local db.


### docker image environment variables
- `BUILD` - if is set to "true" then installs the dependencies
- `ENV` - if is set to "dev" then installs dev dependencies, otherwise it does not (only works if BUILD is set to "true")
- `MIGRATE` - if is set to true then runs all the migrations
- `MIGRATE_FRESH` - if is set to true then removes all tables and then runs all migrations (only works if MIGRATE is set to "true")
- `KILL` - if is set to true then the container is killed before running the web server (useful for just building or migrating)

the following two env vars are set depending on the type of docker installation:

- `USER_UID`
- `USER_GID`

Here is the way to set them:
- for `rootful` install use current user's UID and GID (can be read from the output of the `id` command)
- for `rootless` install use 0 and 0 (root UID and GID)

please note that `rootful` install is the **default**.


### Set up the .env files
Copy the provided .env.sample and update it with correct values (Values there are set for using the compose.yaml).
```bash
cp .env.sample .env
```
now do the same for the .env.compose.sample
```bash
cp .env.compose.sample .env.compose
```

### useful docker commands
- `docker ps` - view basic info of the running docker containers
- `docker exec -ti auto-rent-app /bin/bash` - connect to the app container shell
- `docker logs -f auto-rent-app` - read all logs that are generated by the app as they are created

## Migrations
Yii2 utilises a migration system. The following commands allow one to make sure their schema is up to date

### Run all migrations that were not yet run (the default)
```bash
php yii migrate
```

### Create a new migration
```bash
php yii migrate/create name_of_the_migration
```

### Undo last N migrations
```bash
php yii migrate/down N
```

### Run next N migrations
```bash
php yii migrate/up N
```

### Drop all tables and reapply all migrations
```bash
php yii migrate/fresh
```

